## S2-057漏洞验证

### 1.环境搭建
1. 下载最新的受影响版本：http://archive.apache.org/dist/struts/  Struts2 2.3.34 
2. 漏洞介绍  
	该漏洞由安全研究员Man YueMo发现，在Struts2开发框架中使用namespace功能定义XML配置时，如果该值未被设置且上层动作配置（Action Configuration）中未配置或用通配符namespace，可能导致远程代码执行。同理，URL标签未设置value和action值且上层动作未设置或采用通配符namespace时，也可能导致远程代码执行。  
3. 通过业界的分析博客，由四种受影响的使用，在测试Demo中，仅仅验证触发了Redirect action、URL tag和postback result，而Action chain验证则失败，暂时未找到原因。  
	1. Redirect action 
	2. Action chain
	3. Postback result
	4. \<s:url includeParams="get"\>
4. 使用下载的Struts2，创建web工程，实现以上几处功能，见struts2目录中的代码

* 注意：在最初验证漏洞时，疏忽了一个配置项struts.mapper.alwaysSelectFullNamespace = true(是否总用最后一个斜线前的URL段作为namespace)，该值在默认版本中设置为false，只有手动的改为true，才能出发相关漏洞。  
	<img src="https://github.com/shadow-horse/Learning-resource/blob/master/VulnerabilityAnalysis/S2-057/media/1.png" />	

### 2.漏洞验证

1. Location跳转，回显数值计算结果:${(1+1)}  %{(1+2)}  
	验证redirectAction: http://localhost:8080/struts2/snow/${(10+2)}/action1.action?username=redirect&password=helloworld
  <img src="https://github.com/shadow-horse/Learning-resource/blob/master/VulnerabilityAnalysis/S2-057/media/2.png" />	  
  验证Postback：http://localhost:8080/struts2/%25{(10+2)}/action1.action?username=postback&password=helloworld  
	<img src="https://github.com/shadow-horse/Learning-resource/blob/master/VulnerabilityAnalysis/S2-057/media/4.png" />  
	
  <img src="https://github.com/shadow-horse/Learning-resource/blob/master/VulnerabilityAnalysis/S2-057/media/4.png" />
  
  验证URL TAG：http://localhost:8080/struts2/shadow/%25{(1+14)}/help.action  
  <img src="https://github.com/shadow-horse/Learning-resource/blob/master/VulnerabilityAnalysis/S2-057/media/5.png" />
  
2. 



### 参考
https://xz.aliyun.com/t/2618  
https://github.com/Ivan1ee/struts2-057-exp  
https://lgtm.com/blog/apache_struts_CVE-2018-11776 
https://www.anquanke.com/post/id/157583   
